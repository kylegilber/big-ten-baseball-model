---
title: "2025 Big Ten Baseball Standings Predictor"
author: "kylegilber"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    latex_engine: lualatex
---

```{r Imports, warning=FALSE, echo=FALSE}

# Import packages
library(dplyr)
library(tidyr)
library(purrr)
library(kableExtra)
library(knitr)
library(tinytex)
library(stats)
library(stringr)
library(betareg)
library(pROC)

# Load data
files <- list.files("~/Github/big-ten-baseball-model/data", full.names = TRUE)
invisible(lapply(files, load, envir = .GlobalEnv))
```

```{r Globals, echo=FALSE}

# List teams in the big ten conference
bigten.teams <- c("ILL_ILL", "IU", "IOW_HAW", "MAR_TER", "MIC_SPA", "MIC_WOL", 
  "MIN_GOL", "NEB", "NOR_CAT", "OSU_BUC", "PEN_NIT", "PUR_BOI", "RUT_SCA")

# Specify factors for frequency analysis
factors <- list("PlayResult", "KorBB", "PitchCall", "RunsScored")
```


```{r Cleaning}
#| warning: false
#| message: false
#| echo: false


```

```{r Transformations}
#| warning: false
#| message: false
#| echo: false

# Define summary function ∀ pitchers
summarise_pitchers <- function(data, name) {
  
  # Create a DF for each variable's counts
  counts <- map(cols, ~ data %>% 
    count(Pitcher, .data[[.x]]) %>% 
    pivot_wider(names_from = .data[[.x]], values_from = n, values_fill = 0))
  
  # Count innings pitched ∀ pitchers
  innings <- data %>% 
    distinct(Pitcher, Inning, Date) %>% 
    count(Pitcher, name = "Innings")
  
  # Join data frames by pitcher
  reduce(counts, left_join, by = "Pitcher") %>% 
    left_join(innings, by = "Pitcher") %>% 
    mutate(
      
      # Fielding independent pitching (FIP)
      FIP = (13*HomeRun + 3*(Walk + HitByPitch) - 2*Strikeout)/Innings + 4.22,
      
      # Strikeouts & walks per nine innings (K/9, BB/9)
      K9 = (Strikeout / Innings) * 9, BB9 = (Walk / Innings) * 9,
      
      # Walks & hits per inning pitched
      WHIP = (Walk + Single + Double + 
        tryCatch({Triple}, error = function(cond) {0}) + HomeRun) / Innings,
      
      # Runs allowed
      RA = `1` + 2*`2` + 3*tryCatch({`3`}, error = function(cond) {0}) + 
        4*tryCatch({`4`}, error = function(cond) {0}),
      
    ) %>% 
    
    # Filter pitchers by innings pitched
    filter(Innings >= 5) %>% 
    
    # Summarize pitching stats across team
    summarise(
      Team = name,
      RA = sum(RA),
      across(
        c(FIP, K9, BB9, WHIP),
        list(
          min = ~min(.x),
          q1 = ~quantile(.x, probs = 0.25),
          mean = ~mean(.x),
          median = ~median(.x),
          q3 = ~quantile(.x, probs = 0.75),
          max = ~max(.x),
          sd = ~sd(.x)
        )
      )
    )
}

# Define summary function ∀ batters
summarise_batters <- function(data, name, year) {
  
  # Generate a data frame for each column
  counts <- map(cols, ~ data %>% 
      count(Batter, .data[[.x]]) %>% 
      pivot_wider(names_from = .data[[.x]], values_from = n, values_fill = 0))
  
  # Count plate attempts ∀ batters
  appearances <- data %>% 
    distinct(Batter, Inning, PAofInning, Date) %>% 
    count(Batter, name = "PA")
  
  # Join data frames by batter
  reduce(counts, left_join, by = "Batter") %>% 
    left_join(appearances, by = "Batter") %>% 
    mutate(
      
      # Weighted on-base average (wOBA)
      wOBA = (
        w$wBB[which(w$Year == year)] * Walk + 
        w$wHBP[which(w$Year == year)] * HitByPitch + 
        w$w1B[which(w$Year == year)] * Single +
        w$w2B[which(w$Year == year)] * Double + 
        w$w3B[which(w$Year == year)] * 
        tryCatch({Triple}, error = function(cond) {0}) +
        w$wHR[which(w$Year == year)] * HomeRun) / 
        (PA + Walk + Sacrifice + HitByPitch),
      
      # Strikeout & walk percentage (K%, BB%)
      `K%` = Strikeout / PA, `BB%` = Walk / PA,
      
      # Isolated power (ISO)
      ISO = (Double + 2 * tryCatch({Triple}, error = function(cond) {0}) + 
        3 * HomeRun) / PA,
      
      # Runs (R)
      R = `1` + 2*`2` + 3*tryCatch({`3`}, error = function(cond) {0}) + 
        4*tryCatch({`4`}, error = function(cond) {0})
      
    ) %>% 
    
    # Filter batters by plate appearances
    filter(PA >= 10) %>% 
    
    # Summarize batting stats across team
    summarise(
      Team = name,
      R = sum(R),
      across(
        c(wOBA, `K%`, `BB%`, ISO),
        list(
          min = ~min(.x),
          q1 = ~quantile(.x, probs = 0.25),
          mean = ~mean(.x),
          median = ~median(.x),
          q3 = ~quantile(.x, probs = 0.75),
          max = ~max(.x),
          sd = ~sd(.x)
        )
      )
    )
}
```

```{r Merging}
#| warning: false
#| message: false
#| echo: false

# Merge batting & pitching data ∀ teams
merge_team_data <- function(year) {
    
    # Summarize batting statistics ∀ teams
    batting <- map2_dfr(
      teams, teams, ~summarise_batter(get(paste0(.x, "_B", toString(year))), .y, paste0("20",year))
    )
    
    # Summarize pitching statistics ∀ teams
    pitching <- map2_dfr(
      teams, teams, ~summarise_pitcher(get(paste0(.x, "_P", toString(year))), .y)
    )
    
    # Join batting & pitching by team
    pitching %>% left_join(batting, join_by(Team))
}

## 2022 ##
data22 <- merge_team_data(22)
data22$Year <- "2022"
data22$`Win%` <- c(0.708,0.417,0.708,0.783,0.333,0.5,0.25,0.417,0.417,0.364,
  0.458,0.429,0.708)

## 2023 ##
data23 <- merge_team_data(23)
data23$Year <- "2023"
data23$`Win%` <- c(0.5, 0.667, 0.652, 0.708, 0.542, 0.5, 0.5, 0.625, 0.167, 
  0.375, 0.304, 0.458, 0.583)

## 2024 ##
data24 <- merge_team_data(24)
data24$Year <- "2024"
data24$`Win%` <- c(0.750, 0.625, 0.583, 0.417, 0.583, 0.458, 0.458, 0.667, 0.167,
  0.5, 0.5, 0.542, 0.25)

## 2025 ##
data25 <- merge_team_data(25)
data25$Year <- "2025"
data25$`Win%` <- c(0.571,0.5,0.833,0.286,0.429,0.524,0.333,0.429,0.429,0.143,
  0.5,0.333,0.429)

# Merge season data by year
data <- rbind(data22,data23,data24,data25)

# Convert year var to factor type
data$Year <- factor(data$Year)

# Remove temporary variables
rm(list = ls(pattern = "_"), batting, pitching, cols, summarise_batter, w)
rm(list = ls(pattern = "2"), summarise_pitcher, teams, files, helper, relevel)
```

```{r Table 1}
#| warning: false
#| message: false
#| echo: false

vars <- data.frame(
  Variable = c("Win%","FIP","K9","BB9","WHIP","wOBA","K%","BB%","ISO", "RA", "R"),
  Type = c("Response", rep("Predictor", 10)),
  Explanation = c(
    "Conference Win Percentage - the number of regular season wins against 
    in-conference opponents divided by the total number of games against 
    in-conference opponents multiplied by 100",
    "Average Fielding Independent Pitching (FIP) statistic across the team's 
    pithers with at least 5 innings pitched",
    "Average Strikouts Per Nine innings pitched (K/9) rate across across the
    team's pithers with at least 5 innings pitched",
    "Average Walks Per Nine inning pitched (BB/9) rate across the team's pithers 
    with at least 5 innings pitched",
    "Average Walks Plus Hits Per Innings Pitched (WHIP) statistic across the 
    team's pithers with at least 5 innings pitched",
    "Weighted On-Base Average (wOBA) statistic across players on the team with 
    at least 10 plate appearances",
    "Average Strikeout Percentage across players on the team with at least 10 
    plate appearances",
    "Average Walk Percentage across players on the team with at least 10 plate 
    appearances",
    "Average Isolated Power (ISO) statistic across players on the team with at 
    least plate appearances",
    "Runs Against (RA) - the number of times in the season an opponent made it 
    around the bases to score a run",
    "Runs (R) - the number of times in a season that a player on the team made 
    it around the bases to score a run"),
  Value = c("0 ~ 1","2.89 ~ 12.22","1.5 ~ 15.43","0 ~ 12.86","0.44 ~ 2.47",
    "0.07 ~ 0.46","0 ~ 0.52","0 ~ 0.4","0 ~ 0.5","239 ~ 330","208 ~ 436")
)

vars %>% 
  knitr::kable(
    caption = "Variables used in the analysis",
    align = "l",
  ) %>% 
  kableExtra::kable_styling(
    position = "center",
    bootstrap_options = c("striped")
  ) %>% 
  kable_classic(
    html_font = "Cambria",
    full_width = FALSE
  ) %>% 
  column_spec(3, width = "8cm")
```

```{r}
#| warning: false
#| message: false
#| echo: false

# Set seed for reproducibility
set.seed(123)

# Perform train/test split
indices <- sample(nrow(data), size = 0.9 * nrow(data))
train <- data[indices,]
test <- data[-indices,]

# Train logistic regression model
logistic.model <- glm(
  `Win%` ~ FIP_mean + K9_mean + BB9_mean + WHIP_mean + wOBA_mean + `K%_mean` + 
  `BB%_mean` + ISO_mean + RBI + RA, data = train
)

# Train beta regression model
beta.model <- betareg(
  `Win%` ~ FIP_mean + K9_mean + BB9_mean + WHIP_mean + wOBA_mean + `K%_mean` + 
  `BB%_mean` + ISO_mean + RBI + RA, data = train
)

# Make predictions on test data
logistic.pred <- predict(logistic.model, newdata = test, type = "response")
beta.pred <- predict(beta.model, newdata = test, type = "response")

# Plot histogram of predictions
hist(logistic.pred, main = "Histogram of Predicted Win %", xlab = "Logistic Predictions")
hist(beta.pred, main = "Histogram of Predicted Win %", xlab = "Beta Predictions")

# Root mean squared error (RMSE)
beta.RMSE <- sqrt(mean((test$`Win%` - beta.pred)^2))

# Mean absolute error (MAE)
beta.MAE <- mean(abs(test$`Win%` - beta.pred))

# Pseudo R squared
summary(beta.model$pseudo.r.squared)

test$`Win%`
logistic.pred

rm(indices, size, train, vars, model, i)
rm(test, logistic.model, logistic.pred)
```

```{r EDA}
par(mfrow = c(2,4))

for (i in 4:ncol(data)) {
  if (is.numeric(data[[i]]) & grepl("mean", colnames(data)[i])) {
    hist(data[[i]], xlab = colnames(data)[i], 
      main = str_glue('Histogram of {colnames(data)[i]}'))
  }
}
```
