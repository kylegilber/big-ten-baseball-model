---
title: "2025 Big Ten Baseball Standings Predictor"
author: "kylegilber"
date: "`r Sys.Date()`"
output: github_document
---

```{r, message= f, warning= f, echo= f}

### IMPORTS ###

# Add packages
library(dplyr)
library(tidyr)
library(purrr)

# Load workspace image
load("~/Github/big-ten-baseball-model/data.RData")
```

```{r, message= f, warning= f, echo= f}

### DATA TRANSFORMATION FUNCTIONS ###

# List column variables to count
cols <- list("PlayResult", "KorBB", "PitchCall")

# Define summary function ∀ pitchers
summarise_pitcher <- function(data, name) {
  
  # Generate a data frame for each column
  counts <- map(cols, ~ data %>% 
      count(Pitcher, .data[[.x]]) %>% 
      pivot_wider(names_from = .data[[.x]], values_from = n, values_fill = 0))
  
  # Count innings pitched ∀ pitchers
  innings <- data %>% 
    distinct(Pitcher, Inning, Date) %>% 
    count(Pitcher, name = "Innings")
  
  # Join data frames by pitcher
  reduce(counts, left_join, by = "Pitcher") %>% 
    left_join(innings, by = "Pitcher") %>% 
    mutate(
      
      # Fielding independent pitching (FIP)
      FIP = (13*HomeRun + 3*(Walk + HitByPitch) - 2*Strikeout)/Innings + 4.22,
      
      # # Strikeouts & walks per nine innings (K/9, BB/9)
      K9 = (Strikeout / Innings) * 9, BB9 = (Walk / Innings) * 9,
      
      # Walks & hits per inning pitched
      WHIP = (Walk + Single + Double + 
        tryCatch({Triple}, error = function(cond) {0}) + HomeRun) / Innings
    ) %>% 
    
    # Filter pitchers by innings pitched
    filter(Innings >= 5) %>% 
    
    # Summarize batting statistics across team
    summarise(
      Team = name,
      Pitchers = n(),
      across(
        c(FIP, K9, BB9, WHIP),
        list(
          min = ~min(.x),
          max = ~max(.x),
          median = ~median(.x),
          mean = ~mean(.x),
          mad = ~mad(.x, center = median(.x)),
          stdev = ~sd(.x)
        )
      )
    )
}

# Define summary function ∀ batters
summarise_batter <- function(data, name) {
  
  # Generate a data frame for each column
  counts <- map(cols, ~ data %>% 
      count(Batter, .data[[.x]]) %>% 
      pivot_wider(names_from = .data[[.x]], values_from = n, values_fill = 0))
  
  # Count plate attempts ∀ batters
  appearances <- data %>% 
    distinct(Batter, Inning, PAofInning, Date) %>% 
    count(Batter, name = "PA")
  
  # Join data frames by batter
  reduce(counts, left_join, by = "Batter") %>% 
    left_join(appearances, by = "Batter") %>% 
    mutate(
      
      # Weighted on-base average (wOBA)
      wOBA = (0.812 * Walk + 0.838 * HitByPitch + 0.943 * Single +
        1.271 * Double + 1.616 * tryCatch({Triple}, error = function(cond) {0}) +
        1.764 * HomeRun) / (PA + Walk + Sacrifice + HitByPitch),
      
      # Strikeout & walk percentage (K%, BB%)
      KRate = Strikeout / PA, BBRate = Walk / PA,
      
      # Isolated power (ISO)
      ISO = (Double + 2 * tryCatch({Triple}, error = function(cond) {0}) + 
        3 * HomeRun) / PA
    ) %>% 
    
    # Filter batters by plate appearances
    filter(PA >= 10) %>% 
    
    # Summarize batting statistics across team
    summarise(
      Team = name,
      Batters = n(),
      across(
        c(wOBA, KRate, BBRate, ISO),
        list(
          min = ~min(.x),
          max = ~max(.x),
          median = ~median(.x),
          mean = ~mean(.x),
          mad = ~mad(.x, center = median(.x)),
          stdev = ~sd(.x)
        )
      )
    )
}
```

```{r, message= f, warning= f, echo= f}

### DATA MERGING ###

# Summarize batting statistics for each team
batting <- summarise_batter(ILL_ILL_B, "Illinois") %>% 
  rbind(summarise_batter(IU_B, "Indiana")) %>% 
  rbind(summarise_batter(IOW_HAW_B, "Iowa")) %>% 
  rbind(summarise_batter(MAR_TER_B, "Maryland")) %>% 
  rbind(summarise_batter(MIC_WOL_B, "Michigan")) %>% 
  rbind(summarise_batter(MIC_SPA_B, "Michigan State")) %>% 
  rbind(summarise_batter(MIN_GOP_B, "Minnesota")) %>% 
  rbind(summarise_batter(NEB_B, "Nebraska")) %>% 
  rbind(summarise_batter(NOR_CAT_B, "Northwestern")) %>% 
  rbind(summarise_batter(OSU_BUC_B, "Ohio State")) %>% 
  rbind(summarise_batter(ORE_DUC_B, "Oregon")) %>% 
  rbind(summarise_batter(PEN_NIT_B, "Penn State")) %>% 
  rbind(summarise_batter(PUR_BOI_B, "Purdue")) %>% 
  rbind(summarise_batter(RUT_SCA_B, "Rutgers")) %>% 
  rbind(summarise_batter(UCLA_B, "UCLA")) %>% 
  rbind(summarise_batter(SOU_TRO_B, "USC")) %>% 
  rbind(summarise_batter(WAS_HUS_B, "Washington"))

# Summarize pitching statistics for each team
pitching <- summarise_pitcher(ILL_ILL_P, "Illinois") %>% 
  rbind(summarise_pitcher(IU_P, "Indiana")) %>% 
  rbind(summarise_pitcher(IOW_HAW_P, "Iowa")) %>% 
  rbind(summarise_pitcher(MAR_TER_P, "Maryland")) %>% 
  rbind(summarise_pitcher(MIC_WOL_P, "Michigan")) %>% 
  rbind(summarise_pitcher(MIC_SPA_P, "Michigan State")) %>% 
  rbind(summarise_pitcher(MIN_GOP_P, "Minnesota")) %>% 
  rbind(summarise_pitcher(NEB_P, "Nebraska")) %>% 
  rbind(summarise_pitcher(NOR_CAT_P, "Northwestern")) %>% 
  rbind(summarise_pitcher(OSU_BUC_P, "Ohio State")) %>% 
  rbind(summarise_pitcher(ORE_DUC_P, "Oregon")) %>% 
  rbind(summarise_pitcher(PEN_NIT_P, "Penn State")) %>% 
  rbind(summarise_pitcher(PUR_BOI_P, "Purdue")) %>% 
  rbind(summarise_pitcher(RUT_SCA_P, "Rutgers")) %>% 
  rbind(summarise_pitcher(UCLA_P, "UCLA")) %>% 
  rbind(summarise_pitcher(SOU_TRO_P, "USC")) %>% 
  rbind(summarise_pitcher(WAS_HUS_P, "Washington"))

# Merge team pitching & batting data
data <- pitching %>% left_join(batting, join_by(Team))

# Remove temporary variables
rm(batting, pitching, cols, summarise_batter, summarise_pitcher,
  list= ls(pattern = "_"))
```

