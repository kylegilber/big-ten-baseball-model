---
title: "2025 Big Ten Baseball Standings Predictor"
author: "kylegilber"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    latex_engine: lualatex
---

```{r}
#| warning: false
#| message: false
#| echo: false

### IMPORTS ###

# Add packages
library(dplyr)
library(tidyr)
library(purrr)
library(kableExtra)
library(knitr)
library(tinytex)
library(stats)

# Load season data
files <- list.files("~/Github/big-ten-baseball-model/data", full.names = TRUE)
lapply(files, load, envir = .GlobalEnv)
```

```{r}
#| warning: false
#| message: false
#| echo: false

### DATA TRANSFORMATION FUNCTIONS ###

# List variables to count
cols <- list("PlayResult", "KorBB", "PitchCall", "RunsScored")

# Define summary function ∀ pitchers
summarise_pitcher <- function(data, name) {
  
  # Create a DF for each variable's counts
  counts <- map(cols, ~ data %>% 
      count(Pitcher, .data[[.x]]) %>% 
      pivot_wider(names_from = .data[[.x]], values_from = n, values_fill = 0))
  
  # Count innings pitched ∀ pitchers
  innings <- data %>% 
    distinct(Pitcher, Inning, Date) %>% 
    count(Pitcher, name = "Innings")
  
  # Join data frames by pitcher
  reduce(counts, left_join, by = "Pitcher") %>% 
    left_join(innings, by = "Pitcher") %>% 
    mutate(
      
      # Fielding independent pitching (FIP)
      FIP = (13*HomeRun + 3*(Walk + HitByPitch) - 2*Strikeout)/Innings + 4.22,
      
      # Strikeouts & walks per nine innings (K/9, BB/9)
      K9 = (Strikeout / Innings) * 9, BB9 = (Walk / Innings) * 9,
      
      # Walks & hits per inning pitched
      WHIP = (Walk + Single + Double + 
        tryCatch({Triple}, error = function(cond) {0}) + HomeRun) / Innings,
      
      # Runs allowed
      RA = `1` + 2*`2` + 3*`3` + 4*tryCatch({`4`}, error = function(cond) {0}),
      
    ) %>% 
    
    # Filter pitchers by innings pitched
    filter(Innings >= 5) %>% 
    
    # Summarize pitching stats across team
    summarise(
      Team = name,
      RA = sum(RA),
      across(
        c(FIP, K9, BB9, WHIP),
        list(
          min = ~min(.x),
          max = ~max(.x),
          median = ~median(.x),
          mean = ~mean(.x),
          mad = ~mad(.x, center = median(.x)),
          stdev = ~sd(.x)
        )
      )
    )
}

# Define summary function ∀ batters
summarise_batter <- function(data, name) {
  
  # Generate a data frame for each column
  counts <- map(cols, ~ data %>% 
      count(Batter, .data[[.x]]) %>% 
      pivot_wider(names_from = .data[[.x]], values_from = n, values_fill = 0))
  
  # Count plate attempts ∀ batters
  appearances <- data %>% 
    distinct(Batter, Inning, PAofInning, Date) %>% 
    count(Batter, name = "PA")
  
  # Join data frames by batter
  reduce(counts, left_join, by = "Batter") %>% 
    left_join(appearances, by = "Batter") %>% 
    mutate(
      
      # Weighted on-base average (wOBA)
      wOBA = (0.812 * Walk + 0.838 * HitByPitch + 0.943 * Single +
        1.271 * Double + 1.616 * tryCatch({Triple}, error = function(cond) {0}) +
        1.764 * HomeRun) / (PA + Walk + Sacrifice + HitByPitch),
      
      # Strikeout & walk percentage (K%, BB%)
      `K%` = Strikeout / PA, `BB%` = Walk / PA,
      
      # Isolated power (ISO)
      ISO = (Double + 2 * tryCatch({Triple}, error = function(cond) {0}) + 
        3 * HomeRun) / PA,
      
      # Runs batted in (RBI)
      RBI = `1` + 2*`2` + 3*`3` + 4*tryCatch({`4`}, error = function(cond) {0})
      
    ) %>% 
    
    # Filter batters by plate appearances
    filter(PA >= 10) %>% 
    
    # Summarize batting stats across team
    summarise(
      Team = name,
      RBI = sum(RBI),
      across(
        c(wOBA, `K%`, `BB%`, ISO),
        list(
          min = ~min(.x),
          max = ~max(.x),
          median = ~median(.x),
          mean = ~mean(.x),
          mad = ~mad(.x, center = median(.x)),
          stdev = ~sd(.x)
        )
      )
    )
}
```

```{r}

```


```{r}
#| warning: false
#| message: false
#| echo: false

### DATA MERGING ###

# List universities with baseball teams in the big ten conference in 2024
teams <- list("ILL_ILL", "IU", "IOW_HAW", "MAR_TER", "MIC_WOL", "MIC_SPA", 
  "MIN_GOL", "NEB", "NOR_CAT", "OSU_BUC", "PEN_NIT", "PUR_BOI", "RUT_SCA")

## 2024 ##

# Summarize batting statistics for each team's 2024 roster
batting <- map2_dfr(teams, teams, ~summarise_batter(get(paste0(.x, "_H")), .y))

# Summarize pitching statistics for each team's 2024 roster
pitching <- map2_dfr(teams, teams, ~summarise_pitcher(get(paste0(.x, "_T")), .y))

# Merge team pitching & batting data for 2025 rosters
data24 <- pitching %>% left_join(batting, join_by(Team))

## 2023 ##

# Summarize batting statistics for each team's 2023 roster
batting <- map2_dfr(teams, teams, ~summarise_batter(get(paste0(.x, "_B23")), .y))

# Summarize pitching statistics for each team's 2023 roster
pitching <- map2_dfr(teams, teams, ~summarise_pitcher(get(paste0(.x, "_P23")), .y))

# Merge team pitching & batting data for 2023 rosters
data23 <- pitching %>% left_join(batting, join_by(Team))

# Remove temporary variables
rm(batting, pitching, cols, summarise_batter, summarise_pitcher, teams,
  list = ls(pattern = "_"))
```

```{r}
#| warning: false
#| message: false
#| echo: false

### DATA TRANSFORMATIONS ###

# Add 2024 in-conference win %s
data24$`Win%` <- c(0.750, 0.625, 0.583, 0.417, 0.583, 0.458, 0.458, 0.667, 0.167,
  0.5, 0.5, 0.542, 0.25)

# Add 2025 in-conference win %s to date 
data23$`Win%` <- c(0.5, 0.667, 0.652, 0.708, 0.542, 0.5, 0.5, 0.625, 0.167, 
  0.375, 0.304, 0.458, 0.583)

# Add year and merge
data24$Year <- "2024"
data23$Year <- "2023"
data <- rbind(data24, data23)
rm(data23, data24)
```

```{r}
#| warning: false
#| message: false
#| echo: false

### DATA VISUALIZATION ###

## Table 1

vars <- data.frame(
  Variable = c("Win%","FIP","K9","BB9","WHIP","wOBA","K%","BB%","ISO", "RA", "RBI"),
  Type = c("Response", rep("Predictor", 10)),
  Explanation = c(
    "Conference Win Percentage - the number of regular season wins against 
    in-conference opponents divided by the total number of games against in-
    conference opponents multiplied by 100",
    "Average Fielding Independent Pitching (FIP) statistic across the team's 
    pithers with at least 5 innings pitched",
    "Average Strikouts Per Nine innings pitched (K/9) rate across across the
    team's pithers with at least 5 innings pitched",
    "Average Walks Per Nine inning pitched (BB/9) rate across the team's pithers 
    with at least 5 innings pitched",
    "Average Walks Plus Hits Per Innings Pitched (WHIP) statistic across the 
    team's pithers with at least 5 innings pitched",
    "Weighted On-Base Average (wOBA) statistic across players on the team with 
    at least 10 plate appearances",
    "Average Strikeout Percentage across players on the team with at least 10 
    plate appearances",
    "Average Walk Percentage across players on the team with at least 10 plate 
    appearances",
    "Average Isolated Power (ISO) statistic across players on the team with at 
    least plate appearances",
    "Runs Against (RA) - the number of times in the season an opponent made it 
    around the bases to score a run",
    "Runs (R) - the number of times in a season that a player on the team made 
    it around the bases to score a run"),
  Value = c("0 ~ 1","2.89 ~ 12.22","1.5 ~ 15.43","0 ~ 12.86","0.44 ~ 2.47",
    "0.07 ~ 0.46","0 ~ 0.52","0 ~ 0.4","0 ~ 0.5","239 ~ 330","208 ~ 436")
)

vars %>% 
  knitr::kable(
    caption = "Variables used in the analysis",
    align = "l",
  ) %>% 
  kableExtra::kable_styling(
    position = "center",
    bootstrap_options = c("striped")
  ) %>% 
  kable_classic(
    html_font = "Cambria",
    full_width = FALSE
  ) %>% 
  column_spec(3, width = "8cm")
```

```{r}

# Set seed for reproducibility
set.seed(123)

# Get # rows in data
size <- nrow(data)

# Perform train/test split
indices <- sample(size, size = 0.9 * size)
train <- data[indices,]
test <- data[-indices,]

model <- glm(`Win%` ~ FIP_mean + K9_mean + BB9_mean + WHIP_mean + wOBA_mean + 
  `K%_mean` + `BB%_mean` + ISO_mean + RBI + RA, data = train)
model <- stats::step(model, direction = "backward", trace = FALSE)

prediction <- predict(model, newdata = test)
prediction
```

