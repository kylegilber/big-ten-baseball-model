---
title: "2025 Big Ten Baseball Standings Predictor"
author: "kylegilber"
date: "`r Sys.Date()`"
output: github_document
---

```{r, message= f, warning= f, echo= f}

### IMPORTS ###

# Add packages
library(dplyr)
library(tidyr)
library(purrr)

# Load 2024 player data 
load("~/Github/big-ten-baseball-model/data24.RData")

# Load 2024 player data with updated 2025 rosters
load("~/Github/big-ten-baseball-model/data25.RData")
```

```{r, message= f, warning= f, echo= f}

### DATA TRANSFORMATION FUNCTIONS ###

# List column variables to count
cols <- list("PlayResult", "KorBB", "PitchCall")

# Define summary function ∀ pitchers
summarise_pitcher <- function(data, name) {
  
  # Generate a data frame for each column
  counts <- map(cols, ~ data %>% 
      count(Pitcher, .data[[.x]]) %>% 
      pivot_wider(names_from = .data[[.x]], values_from = n, values_fill = 0))
  
  # Count innings pitched ∀ pitchers
  innings <- data %>% 
    distinct(Pitcher, Inning, Date) %>% 
    count(Pitcher, name = "Innings")
  
  # Join data frames by pitcher
  reduce(counts, left_join, by = "Pitcher") %>% 
    left_join(innings, by = "Pitcher") %>% 
    mutate(
      
      # Fielding independent pitching (FIP)
      FIP = (13*HomeRun + 3*(Walk + HitByPitch) - 2*Strikeout)/Innings + 4.22,
      
      # # Strikeouts & walks per nine innings (K/9, BB/9)
      K9 = (Strikeout / Innings) * 9, BB9 = (Walk / Innings) * 9,
      
      # Walks & hits per inning pitched
      WHIP = (Walk + Single + Double + 
        tryCatch({Triple}, error = function(cond) {0}) + HomeRun) / Innings
    ) %>% 
    
    # Filter pitchers by innings pitched
    filter(Innings >= 5) %>% 
    
    # Summarize batting statistics across team
    summarise(
      Team = name,
      Pitchers = n(),
      across(
        c(FIP, K9, BB9, WHIP),
        list(
          min = ~min(.x),
          max = ~max(.x),
          median = ~median(.x),
          mean = ~mean(.x),
          mad = ~mad(.x, center = median(.x)),
          stdev = ~sd(.x)
        )
      )
    )
}

# Define summary function ∀ batters
summarise_batter <- function(data, name) {
  
  # Generate a data frame for each column
  counts <- map(cols, ~ data %>% 
      count(Batter, .data[[.x]]) %>% 
      pivot_wider(names_from = .data[[.x]], values_from = n, values_fill = 0))
  
  # Count plate attempts ∀ batters
  appearances <- data %>% 
    distinct(Batter, Inning, PAofInning, Date) %>% 
    count(Batter, name = "PA")
  
  # Join data frames by batter
  reduce(counts, left_join, by = "Batter") %>% 
    left_join(appearances, by = "Batter") %>% 
    mutate(
      
      # Weighted on-base average (wOBA)
      wOBA = (0.812 * Walk + 0.838 * HitByPitch + 0.943 * Single +
        1.271 * Double + 1.616 * tryCatch({Triple}, error = function(cond) {0}) +
        1.764 * HomeRun) / (PA + Walk + Sacrifice + HitByPitch),
      
      # Strikeout & walk percentage (K%, BB%)
      KRate = Strikeout / PA, BBRate = Walk / PA,
      
      # Isolated power (ISO)
      ISO = (Double + 2 * tryCatch({Triple}, error = function(cond) {0}) + 
        3 * HomeRun) / PA
    ) %>% 
    
    # Filter batters by plate appearances
    filter(PA >= 10) %>% 
    
    # Summarize batting statistics across team
    summarise(
      Team = name,
      Batters = n(),
      across(
        c(wOBA, KRate, BBRate, ISO),
        list(
          min = ~min(.x),
          max = ~max(.x),
          median = ~median(.x),
          mean = ~mean(.x),
          mad = ~mad(.x, center = median(.x)),
          stdev = ~sd(.x)
        )
      )
    )
}
```

```{r}
#| warning: false
#| message: false
#| echo: false

### DATA MERGING ###

# List universities with baseball teams in the big ten conference
teams <- list("ILL_ILL", "IU", "IOW_HAW", "MAR_TER", "MIC_WOL", "MIC_SPA", 
  "MIN_GOP", "NEB", "NOR_CAT", "OSU_BUC", "ORE_DUC", "PEN_NIT", "PUR_BOI",
  "RUT_SCA", "UCLA", "SOU_TRO", "WAS_HUS")
  
# Standardize Minnesota names
MIN_GOP_H <- MIN_GOL_H
MIN_GOP_T <- MIN_GOL_T
rm(MIN_GOL_H, MIN_GOL_T)

## 2024 ##

# Summarize batting statistics for each team's 2024 roster
batting <- map2_dfr(teams, teams, ~summarise_batter(get(paste0(.x, "_H")), .y))

# Summarize pitching statistics for each team's 2024 roster
pitching <- map2_dfr(teams, teams, ~summarise_pitcher(get(paste0(.x, "_T")), .y))

# Merge team pitching & batting data for 2025 rosters
data24 <- pitching %>% left_join(batting, join_by(Team))

## 2025 ##

# Summarize batting statistics for each team's 2025 roster
batting <- map2_dfr(teams, teams, ~summarise_batter(get(paste0(.x, "_B")), .y))

# Summarize pitching statistics for each team's 2025 roster
pitching <- map2_dfr(teams, teams, ~summarise_pitcher(get(paste0(.x, "_P")), .y))

# Merge team pitching & batting data for 2025 rosters
data25 <- pitching %>% left_join(batting, join_by(Team))

# Remove temporary variables
rm(batting, pitching, cols, summarise_batter, summarise_pitcher, teams,
  list = ls(pattern = "_"))
```

