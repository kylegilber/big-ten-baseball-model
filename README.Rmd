---
title: "2025 Big Ten Baseball Standings Predictor"
author: "kylegilber"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    latex_engine: lualatex
---

```{r Imports, warning=FALSE, echo=FALSE}

# Import packages
library(dplyr)
library(tidyr)
library(purrr)
library(kableExtra)
library(knitr)
library(tinytex)
library(stats)
library(stringr)
library(betareg)
library(pROC)

# Load data
files <- list.files("~/Github/big-ten-baseball-model/data", full.names = TRUE)
invisible(lapply(files, load, envir = .GlobalEnv))
```

```{r Globals, echo=FALSE}

# List teams in the big ten conference
bigten.teams <- c("ILL_ILL", "IU", "IOW_HAW", "MAR_TER", "MIC_SPA", "MIC_WOL", 
  "MIN_GOL", "NEB", "NOR_CAT", "OSU_BUC", "PEN_NIT", "PUR_BOI", "RUT_SCA")

# Specify factors for frequency analysis
factors <- list("PlayResult", "KorBB", "PitchCall", "RunsScored")

# Specify grouping variables
variables <- c("GameID", "HomeTeam", "AwayTeam", "Date")
```


```{r Cleaning, warning=FALSE, echo=FALSE}

# Loop through global environment
for (name in ls()) {
  
  # Get environment objects
  object <- get(name)
  
  # Get data frame objects
  if (is.data.frame(object) & grepl(paste(bigten.teams, collapse = "|"), name)) {
    
    # Remove "undefined" factor level
    levels(object$PlayResult)[levels(object$PlayResult) == "Undefined"] <- NA
    levels(object$KorBB)[levels(object$KorBB) == "Undefined"] <- NA
    
    # Filter in-conference game data
    temp <- subset(object, HomeTeam %in% bigten.teams & AwayTeam %in% bigten.teams)
    assign(name, temp)
  }
}

# Remove temporary variables
rm(name, files, temp, object)
```

```{r Transformations, echo=FALSE}

# Define frequency analysis function
freq <- function(data, type) {
  map(factors, ~ data %>% 
    count(GameID, {{type}}, .data[[.x]]) %>% 
    pivot_wider(
      names_from = .data[[.x]],
      values_from = n,
      values_fill = 0
    )
  )
}

# Define function to summarize team data
summarize.team <- function(data) {
  
  # Frequency analysis for factors
  pitcher.counts <- freq(data, Pitcher)
  batter.counts <- freq(data, Batter)
  
  # Derive innings-pitched pitcher statistic
  IP <- data %>% distinct(!!!syms(variables), Inning, Pitcher, PitcherTeam) %>% 
    count(!!!syms(variables), Date, Pitcher, PitcherTeam, name = "IP")
  
  # Derive plate appearances batting statistic
  PA <- data %>% distinct(!!!syms(variables), Inning, PAofInning, Batter, BatterTeam) %>%
    count(!!!syms(variables), Date, Batter, BatterTeam, name = "PA")
  
  # Specify variables to join by
  keys <- c("GameID", "Pitcher")
  
  # Join pitcher counts and innings pitched
  pitcher.data <- left_join(IP, reduce(pitcher.counts, left_join, by = keys), by = keys) %>% 
    mutate(
      
      # Fielding independent pitching (FIP)
      FIP = (13*HomeRun + 3*(Walk + HitByPitch) - 2*Strikeout) / IP + 4.22,
      
      # Strikeouts & walks per nine innings (K/9, BB/9)
      K9 = (Strikeout / IP) * 9, BB9 = (Walk / IP) * 9,
      
      # Walks & hits per inning pitched
      WHIP = (Walk + Single + Double + 
        tryCatch({Triple}, error = function(cond) {0}) + HomeRun) / IP
      
    ) %>% 
    
    # Summarize across both teams
    reframe(
      Date = Date,
      HomeTeam = HomeTeam,
      AwayTeam = AwayTeam,
      across(
        c(FIP, K9, BB9, WHIP),
        ~mean(.x[PitcherTeam == HomeTeam]),
        .names = "Home_{.col}"),
      across(
        c(FIP, K9, BB9, WHIP),
        ~mean(.x[PitcherTeam == AwayTeam]),
        .names = "Away_{.col}"),
      .by = GameID
    )
  
  # Update keys for batter data
  keys <- c("GameID", "Batter")
  
  # Join batter counts and plate appearances
  batter.data <- left_join(PA, reduce(batter.counts, left_join, by = keys), by = keys) %>% 
    mutate(
      
      # Weighted on-base average (wOBA)
      wOBA = (0.812*Walk + 0.838*HitByPitch + 0.943*Single + 1.245*Double + 
        1.537*tryCatch({Triple}, error = function(cond) {0}) + 1.764*HomeRun) 
        / (PA + Walk + Sacrifice + HitByPitch),
      
      # Strikeout & walk percentage (K%, BB%)
      `K%` = Strikeout / PA, `BB%` = Walk / PA,
      
      # Isolated power (ISO)
      ISO = (Double + 2 * tryCatch({Triple}, error = function(cond) {0}) + 
        3 * HomeRun) / PA
      
    ) %>% 

    # Summarize across both teams
    reframe(
      Date = Date,
      HomeTeam = HomeTeam,
      AwayTeam = AwayTeam,
      across(
        c(wOBA, `K%`, `BB%`, ISO),
        ~mean(.x[BatterTeam == HomeTeam]),
        .names = "Home_{.col}"),
      across(
        c(wOBA, `K%`, `BB%`, ISO),
        ~mean(.x[BatterTeam == AwayTeam]),
        .names = "Away_{.col}"),
      .by = GameID
    )
  
  # Join batter and pitcher summary data
  pitcher.data %>% left_join(batter.data, by = "GameID") %>% distinct() %>% select(-GameID)
  
}
```

```{r Merging}
#| warning: false
#| message: false
#| echo: false


```

```{r Table 1}
#| warning: false
#| message: false
#| echo: false

vars <- data.frame(
  Variable = c("Win%","FIP","K9","BB9","WHIP","wOBA","K%","BB%","ISO", "RA", "R"),
  Type = c("Response", rep("Predictor", 10)),
  Explanation = c(
    "Conference Win Percentage - the number of regular season wins against 
    in-conference opponents divided by the total number of games against 
    in-conference opponents multiplied by 100",
    "Average Fielding Independent Pitching (FIP) statistic across the team's 
    pithers with at least 5 innings pitched",
    "Average Strikouts Per Nine innings pitched (K/9) rate across across the
    team's pithers with at least 5 innings pitched",
    "Average Walks Per Nine inning pitched (BB/9) rate across the team's pithers 
    with at least 5 innings pitched",
    "Average Walks Plus Hits Per Innings Pitched (WHIP) statistic across the 
    team's pithers with at least 5 innings pitched",
    "Weighted On-Base Average (wOBA) statistic across players on the team with 
    at least 10 plate appearances",
    "Average Strikeout Percentage across players on the team with at least 10 
    plate appearances",
    "Average Walk Percentage across players on the team with at least 10 plate 
    appearances",
    "Average Isolated Power (ISO) statistic across players on the team with at 
    least plate appearances",
    "Runs Against (RA) - the number of times in the season an opponent made it 
    around the bases to score a run",
    "Runs (R) - the number of times in a season that a player on the team made 
    it around the bases to score a run"),
  Value = c("0 ~ 1","2.89 ~ 12.22","1.5 ~ 15.43","0 ~ 12.86","0.44 ~ 2.47",
    "0.07 ~ 0.46","0 ~ 0.52","0 ~ 0.4","0 ~ 0.5","239 ~ 330","208 ~ 436")
)

vars %>% 
  knitr::kable(
    caption = "Variables used in the analysis",
    align = "l",
  ) %>% 
  kableExtra::kable_styling(
    position = "center",
    bootstrap_options = c("striped")
  ) %>% 
  kable_classic(
    html_font = "Cambria",
    full_width = FALSE
  ) %>% 
  column_spec(3, width = "8cm")
```

```{r}
#| warning: false
#| message: false
#| echo: false

# Set seed for reproducibility
set.seed(123)

# Perform train/test split
indices <- sample(nrow(data), size = 0.9 * nrow(data))
train <- data[indices,]
test <- data[-indices,]

# Train logistic regression model
logistic.model <- glm(
  `Win%` ~ FIP_mean + K9_mean + BB9_mean + WHIP_mean + wOBA_mean + `K%_mean` + 
  `BB%_mean` + ISO_mean + RBI + RA, data = train
)

# Train beta regression model
beta.model <- betareg(
  `Win%` ~ FIP_mean + K9_mean + BB9_mean + WHIP_mean + wOBA_mean + `K%_mean` + 
  `BB%_mean` + ISO_mean + RBI + RA, data = train
)

# Make predictions on test data
logistic.pred <- predict(logistic.model, newdata = test, type = "response")
beta.pred <- predict(beta.model, newdata = test, type = "response")

# Plot histogram of predictions
hist(logistic.pred, main = "Histogram of Predicted Win %", xlab = "Logistic Predictions")
hist(beta.pred, main = "Histogram of Predicted Win %", xlab = "Beta Predictions")

# Root mean squared error (RMSE)
beta.RMSE <- sqrt(mean((test$`Win%` - beta.pred)^2))

# Mean absolute error (MAE)
beta.MAE <- mean(abs(test$`Win%` - beta.pred))

# Pseudo R squared
summary(beta.model$pseudo.r.squared)

test$`Win%`
logistic.pred

rm(indices, size, train, vars, model, i)
rm(test, logistic.model, logistic.pred)
```

```{r EDA}
par(mfrow = c(2,4))

for (i in 4:ncol(data)) {
  if (is.numeric(data[[i]]) & grepl("mean", colnames(data)[i])) {
    hist(data[[i]], xlab = colnames(data)[i], 
      main = str_glue('Histogram of {colnames(data)[i]}'))
  }
}
```
